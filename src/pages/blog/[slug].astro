---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import CTASection from '../../components/CTASection.astro';
import RelatedArticles from '../../components/RelatedArticles.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import FAQSection from '../../components/FAQSection.astro';
import ProgressIndicator from '../../components/ProgressIndicator.astro';
import SocialShareButtons from '../../components/SocialShareButtons.astro';
import NewsletterSignup from '../../components/NewsletterSignup.astro';
import NewsletterModal from '../../components/NewsletterModal.astro';
import NewsletterSidebar from '../../components/NewsletterSidebar.astro';
import { blogPosts, getBlogPostSlugs } from '../../data/blog';
import { products } from '../../data/products';
import { trackPageView, setupScrollTracking, trackTimeOnPage } from '../../lib/posthog';

export function getStaticPaths() {
  return getBlogPostSlugs().map(slug => ({ params: { slug } }));
}

const { slug } = Astro.params;
const post = blogPosts[slug];

if (!post) {
  return Astro.redirect('/404');
}

// SEO meta data
const seoTitle = post.title;
const seoDescription = post.metaDescription || post.excerpt;
const seoKeywords = post.keywords?.join(', ') || '';

// Get related posts for internal linking
const relatedPosts = post.relatedPosts
  ?.map(s => blogPosts[s])
  .filter(Boolean) || [];

// Get related products for affiliate CTAs
const relatedProducts = post.affiliateProducts
  ?.map(id => products.find(p => p.id === id))
  .filter(Boolean) || [];

// Calculate word count if not provided
const wordCount = post.wordCount || post.content.split(/\s+/).length;

// Generate schema markup
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.title,
  "description": seoDescription,
  "image": `https://thebestoffersaround.com${post.image}`,
  "author": {
    "@type": "Organization",
    "name": "The Best Offers Around"
  },
  "publisher": {
    "@type": "Organization",
    "name": "The Best Offers Around",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thebestoffersaround.com/logo.png"
    }
  },
  "datePublished": post.date,
  "dateModified": post.date,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://thebestoffersaround.com/blog/${slug}`
  }
};

// Add keywords to schema if available
if (post.keywords && post.keywords.length > 0) {
  articleSchema.keywords = post.keywords.join(', ');
}
---

<Layout title={`${seoTitle} | The Best Offers Around`} description={seoDescription} type="article">
  <!-- Additional SEO meta tags -->
  <meta name="keywords" content={seoKeywords} />
  <meta name="article:published_time" content={post.date} />
  <meta name="article:author" content={post.author} />
  <meta name="article:section" content={post.category} />

  <!-- Article Schema -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <!-- Progress Indicator -->
  <ProgressIndicator articleSlug={slug} />

  <Header />

  <main class="flex-grow">
    <section class="bg-off-black py-4">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <nav class="text-sm">
          <a href="/" class="text-gold hover:underline">Home</a>
          <span class="text-gray-500 mx-2">/</span>
          <a href="/blog" class="text-gold hover:underline">Blog</a>
          <span class="text-gray-500 mx-2">/</span>
          <span class="text-gray-400">{post.title}</span>
        </nav>
      </div>
    </section>

    <article class="relative bg-gradient-to-br from-off-black via-dark-gray to-off-black py-16 sm:py-20 overflow-hidden">
      <!-- Decorative background elements -->
      <div class="absolute inset-0 opacity-5">
        <div class="absolute top-0 right-0 w-96 h-96 bg-gold rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2"></div>
        <div class="absolute bottom-0 left-0 w-96 h-96 bg-gold rounded-full blur-3xl transform -translate-x-1/2 translate-y-1/2"></div>
      </div>

      <div class="relative max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid lg:grid-cols-[1fr,300px] gap-8">
          <!-- Main Content -->
          <div class="space-y-8">
            <!-- Category Badge -->
            <div class="flex items-center gap-4">
              <span class="inline-flex items-center gap-2 bg-gradient-to-r from-gold/20 to-amber-600/20 text-gold px-4 py-2 rounded-full text-sm font-bold border border-gold/30 shadow-lg shadow-gold/10">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                {post.category}
              </span>
            </div>

            <!-- Title -->
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-off-white leading-tight">
              {post.title}
            </h1>

            <!-- Enhanced Metadata -->
            <div class="flex flex-wrap items-center gap-4 text-sm">
              <div class="flex items-center gap-3 bg-darker-gray px-4 py-2 rounded-full border border-gray-800">
                <div class="w-8 h-8 bg-gradient-to-br from-gold to-amber-600 rounded-full flex items-center justify-center">
                  <svg class="w-4 h-4 text-off-black" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <span class="text-gray-300 font-medium">{post.author}</span>
              </div>

              <div class="flex items-center gap-3 bg-darker-gray px-4 py-2 rounded-full border border-gray-800">
                <svg class="w-4 h-4 text-gold" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                </svg>
                <span class="text-gray-300">{new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
              </div>

              <div class="flex items-center gap-3 bg-darker-gray px-4 py-2 rounded-full border border-gray-800">
                <svg class="w-4 h-4 text-gold" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                </svg>
                <span class="text-gray-300">{post.readTime}</span>
              </div>

              <div class="flex items-center gap-3 bg-darker-gray px-4 py-2 rounded-full border border-gray-800">
                <svg class="w-4 h-4 text-gold" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-gray-300">{wordCount} words</span>
              </div>
            </div>

            <!-- Hero Image with Enhanced Styling -->
            <div class="relative -mx-4 sm:mx-0 group">
              <div class="absolute inset-0 bg-gradient-to-r from-gold/20 to-amber-600/20 rounded-2xl blur-xl opacity-50 group-hover:opacity-75 transition-opacity duration-300"></div>
              <img src={post.image} alt={`${post.title} featured image`} class="relative w-full rounded-2xl shadow-2xl border border-gray-800" />
            </div>

            <!-- Initial CTA (if related products) -->
            {relatedProducts.length > 0 && (
              <CTASection
                productName={relatedProducts[0].name}
                productSlug={relatedProducts[0].slug}
                affiliateLink={relatedProducts[0].affiliateLink}
                title="Looking for the Best Solution?"
                description={`Based on our research, ${relatedProducts[0].name} offers the best results for ${post.category.toLowerCase()}.`}
                location="intro"
                articleSlug={slug}
                articleCategory={post.category}
              />
            )}
          </div>

          <!-- Sidebar with TOC and Social -->
          <aside class="hidden lg:block space-y-6">
            <TableOfContents content={post.content} />
            <NewsletterSidebar />
          </aside>
        </div>
      </div>
    </article>

    <article class="py-16 bg-gradient-to-b from-dark-gray to-darker-gray relative">
      <!-- Subtle pattern overlay -->
      <div class="absolute inset-0 opacity-5" style="background-image: radial-gradient(circle at 2px 2px, #d4af37 1px, transparent 0); background-size: 40px 40px;"></div>

      <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Article Content with Enhanced Typography -->
        <div class="prose-article bg-dark-gray/50 backdrop-blur-sm rounded-2xl p-8 sm:p-12 shadow-2xl border border-gray-800/50">
          <div set:html={post.content} />
        </div>
      </div>
    </article>

        <!-- Mid-article CTA -->
        {relatedProducts.length > 1 && (
          <CTASection
            productName={relatedProducts[1].name}
            productSlug={relatedProducts[1].slug}
            affiliateLink={relatedProducts[1].affiliateLink}
            variant="secondary"
            location="mid-article"
            articleSlug={slug}
            articleCategory={post.category}
          />
        )}

        <!-- Related Articles -->
        <RelatedArticles
          currentSlug={slug}
          category={post.category}
          maxArticles={4}
        />

        <!-- Newsletter Signup -->
        <div class="max-w-2xl mx-auto">
          <NewsletterSignup placement="article-end" />
        </div>

        <!-- Social Share Buttons -->
        <div class="max-w-2xl mx-auto">
          <h3 class="text-center text-gray-300 mb-4">Share this article</h3>
          <SocialShareButtons
            url={`https://thebestoffersaround.com/blog/${slug}/`}
            title={post.title}
            description={post.excerpt}
            image={`https://thebestoffersaround.com${post.image}`}
            platforms={['twitter', 'linkedin', 'facebook', 'copy']}
            showLabels={true}
            orientation="horizontal"
          />
        </div>

        <!-- Final CTA -->
        {relatedProducts.length > 0 && (
          <CTASection
            productName={relatedProducts[0].name}
            productSlug={relatedProducts[0].slug}
            affiliateLink={relatedProducts[0].affiliateLink}
            title="Ready to Transform Your Health?"
            description={`Take the first step towards better health with ${relatedProducts[0].name}. Join thousands of satisfied customers today.`}
            variant="primary"
            location="conclusion"
            articleSlug={slug}
            articleCategory={post.category}
          />
        )}

        <div class="mt-12 pt-8 border-t border-gray-800">
          <div class="flex flex-wrap justify-between items-center gap-4">
            <div class="flex gap-4">
              <span class="text-gray-400">Categories:</span>
              <a href={`/category/${post.category.toLowerCase().replace(/\s+/g, '-')}`} class="text-gold hover:underline">
                {post.category}
              </a>
            </div>
            <div class="flex gap-4">
              <a href="/blog" class="text-gold hover:underline">‚Üê Back to Blog</a>
            </div>
          </div>
        </div>
      </div>
    </article>
  </main>

  <!-- Newsletter Modal -->
  <NewsletterModal delay={30} />

  <Footer />
</Layout>

<script>
  // Initialize tracking
  import { trackPageView, setupScrollTracking, trackTimeOnPage } from '../../lib/posthog';

  // Set current article info for global tracking
  window.currentArticleSlug = '{slug}';
  window.currentArticleCategory = '{post.category}';

  // Track page view
  trackPageView({
    article_title: '{post.title}',
    category: '{post.category}',
    word_count: {wordCount},
    page_type: 'blog'
  });

  // Setup scroll tracking
  const cleanupScroll = setupScrollTracking('{slug}');

  // Track time on page when user leaves
  const cleanupTime = trackTimeOnPage('{slug}');

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (cleanupTime) cleanupTime();
  });
</script>
