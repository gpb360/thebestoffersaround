---
/**
 * TableOfContents Component
 * Generates sticky table of contents for long-form articles
 */

interface Props {
  content: string;
  title?: string;
}

const { content, title = 'Table of Contents' } = Astro.props;

// Extract headings from content
const headingRegex = /<h([2-3])[^>]*id="([^"]*)"[^>]*>(.*?)<\/h\1>/g;
const headings: Array<{ level: number; id: string; text: string }> = [];

let match;
while ((match = headingRegex.exec(content)) !== null) {
  headings.push({
    level: parseInt(match[1]),
    id: match[2],
    text: match[3].replace(/<[^>]*>/g, ''), // Strip HTML tags
  });
}

const hasHeadings = headings.length > 3; // Only show if 4+ headings
---

{hasHeadings && (
  <aside class="toc relative">
    <!-- Glow effect -->
    <div class="absolute inset-0 bg-gradient-to-b from-gold/10 to-transparent rounded-2xl blur-xl"></div>

    <div class="relative sticky top-4 bg-gradient-to-b from-dark-gray to-darker-gray border border-gold/20 rounded-2xl p-6 shadow-2xl">
      <h3 class="text-lg font-bold text-off-white mb-4 flex items-center gap-2">
        <div class="p-2 bg-gold/10 rounded-lg">
          <svg class="w-5 h-5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
          </svg>
        </div>
        {title}
      </h3>

      <!-- Progress indicator for TOC -->
      <div class="mb-4 h-1 bg-gray-800 rounded-full overflow-hidden">
        <div class="toc-progress h-full bg-gradient-to-r from-gold to-amber-600 transition-all duration-300" style="width: 0%"></div>
      </div>

      <nav class="space-y-1">
        {headings.map((heading, index) => (
          <a
            href={`#${heading.id}`}
            class={`toc-link group flex items-center gap-3 py-2 px-3 rounded-lg text-sm transition-all duration-300 ${
              heading.level === 3
                ? 'ml-4 text-gray-400 hover:text-gray-300 hover:bg-gray-800/50'
                : 'text-gray-300 font-medium hover:text-gold hover:bg-gold/5'
            }`}
            data-target={heading.id}
          >
            <span class="flex-shrink-0 w-5 h-5 flex items-center justify-center text-xs text-gray-500 group-hover:text-gold transition-colors">
              {index + 1}
            </span>
            <span class="flex-1">{heading.text}</span>
            <svg class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0 duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        ))}
      </nav>
    </div>
  </aside>
)}

<script>
  // Smooth scroll and active state tracking
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');

    // Smooth scroll
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        const href = (e.currentTarget as HTMLElement).getAttribute('href');
        if (href) {
          e.preventDefault();
          const target = document.querySelector(href);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }
      });
    });

    // Update active state on scroll
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach(entry => {
          const id = entry.target.id;
          const link = document.querySelector(`.toc-link[data-target="${id}"]`);

          if (entry.isIntersecting) {
            // Remove active from all links
            tocLinks.forEach(l => l.classList.remove('text-gold'));
            // Add active to current link
            if (link) link.classList.add('text-gold');
          }
        });
      },
      { rootMargin: '-100px 0px -66%' }
    );

    // Observe all headings
    document.querySelectorAll('h2[id], h3[id]').forEach(heading => {
      observer.observe(heading);
    });
  });
</script>

<style>
  .toc {
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }

  .toc::-webkit-scrollbar {
    width: 4px;
  }

  .toc::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
  }

  .toc::-webkit-scrollbar-thumb {
    background: rgba(234, 179, 8, 0.5);
    border-radius: 2px;
  }

  .toc-link {
    border-left: 2px solid transparent;
    padding-left: 0.75rem;
  }

  .toc-link:hover {
    border-left-color: rgb(234, 179, 8);
  }

  .toc-link.text-gold {
    border-left-color: rgb(234, 179, 8);
  }
</style>
