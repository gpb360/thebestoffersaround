---
/**
 * Newsletter Signup Component
 * Inline email capture form with GDPR compliance and tracking
 */

interface Props {
  placement?: 'hero' | 'article-end' | 'sidebar';
  headline?: string;
  description?: string;
  ctaText?: string;
  showLeadMagnet?: boolean;
}

const {
  placement = 'article-end',
  headline = 'Get Expert Health Tips & Exclusive Deals',
  description = 'Join 10,000+ readers. Weekly supplement reviews, men\'s health tips, and subscriber-only discounts.',
  ctaText = 'Subscribe Now',
  showLeadMagnet = true
} = Astro.props;

const placementStyles = {
  hero: 'bg-gradient-to-r from-gold/10 to-gold/5 border-gold/20',
  'article-end': 'bg-gradient-to-br from-gold/10 to-transparent border-gold/30',
  sidebar: 'bg-gold/5 border-gold/20'
};

const containerClass = placementStyles[placement];
---

<div class={`newsletter-signup rounded-lg border p-6 ${containerClass}`} data-placement={placement}>
  <div class="newsletter-signup-content">
    <!-- Headline -->
    <h3 class="text-xl font-bold text-gold mb-2">
      {headline}
    </h3>

    <!-- Description -->
    <p class="text-gray-300 text-sm mb-4">
      {description}
    </p>

    <!-- Lead Magnet -->
    {showLeadMagnet && (
      <div class="bg-gold/10 rounded border border-gold/20 p-3 mb-4">
        <p class="text-sm text-gold font-medium mb-1">üéÅ Free Bonus:</p>
        <p class="text-xs text-gray-300">
          Get our "Ultimate Supplement Guide" PDF when you subscribe
        </p>
      </div>
    )}

    <!-- Signup Form -->
    <form
      id="newsletter-form-{placement}"
      class="newsletter-form space-y-3"
      data-placement={placement}
    >
      <!-- Email Input -->
      <div>
        <label for="email-{placement}" class="sr-only">Email address</label>
        <input
          type="email"
          id="email-{placement}"
          name="email"
          required
          placeholder="Enter your email"
          class="w-full px-4 py-3 bg-off-black border border-gold/30 rounded text-white placeholder-gray-400 focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition"
          data-newsletter-input
        />
      </div>

      <!-- GDPR Consent -->
      <label class="flex items-start gap-2 cursor-pointer">
        <input
          type="checkbox"
          required
          class="mt-1 w-4 h-4 rounded border-gold/30 bg-off-black text-gold focus:ring-gold/20"
          data-newsletter-consent
        />
        <span class="text-xs text-gray-400">
          I agree to receive emails and accept the <a href="/privacy" class="text-gold hover:underline">privacy policy</a>
        </span>
      </label>

      <!-- Submit Button -->
      <button
        type="submit"
        class="w-full bg-gold hover:bg-gold/90 text-off-black font-bold py-3 px-6 rounded transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
        data-newsletter-submit
      >
        <span>{ctaText}</span>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
        </svg>
      </button>

      <!-- Success Message -->
      <div class="hidden success-message bg-green-500/20 border border-green-500/30 rounded p-3 text-center">
        <p class="text-green-400 font-medium text-sm">‚úì Almost done! Check your inbox to confirm.</p>
      </div>

      <!-- Error Message -->
      <div class="hidden error-message bg-red-500/20 border border-red-500/30 rounded p-3 text-center">
        <p class="text-red-400 text-sm">Something went wrong. Please try again.</p>
      </div>
    </form>

    <!-- Trust Badges -->
    <div class="flex items-center justify-center gap-4 mt-4 text-xs text-gray-400">
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
        </svg>
        No spam
      </span>
      <span class="flex items-center gap-1">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        Unsubscribe anytime
      </span>
    </div>
  </div>
</div>

<script>
  // Newsletter form handling with PostHog tracking
  document.addEventListener('DOMContentLoaded', () => {
    const forms = document.querySelectorAll('.newsletter-form');

    forms.forEach(form => {
      const placement = form.getAttribute('data-placement');
      const submitBtn = form.querySelector('[data-newsletter-submit]');
      const successMsg = form.querySelector('.success-message');
      const errorMsg = form.querySelector('.error-message');
      const emailInput = form.querySelector('[data-newsletter-input]');

      // Track form view
      if (window.posthog) {
        window.posthog.capture('signup_form_viewed', {
          placement,
          timestamp: new Date().toISOString()
        });
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = emailInput.value;

        // Track signup attempt
        if (window.posthog) {
          window.posthog.capture('signup_form_submitted', {
            placement,
            timestamp: new Date().toISOString()
          });
        }

        // Validate email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          errorMsg.classList.remove('hidden');
          setTimeout(() => errorMsg.classList.add('hidden'), 5000);
          return;
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>Subscribing...</span>';

        try {
          const response = await fetch('/api/newsletter/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, placement })
          });

          if (response.ok) {
            // Track success
            if (window.posthog) {
              window.posthog.capture('signup_form_success', {
                placement,
                timestamp: new Date().toISOString()
              });
              window.posthog.identify(email);
            }

            // Show success message
            successMsg.classList.remove('hidden');
            form.reset();
          } else {
            throw new Error('Subscription failed');
          }
        } catch (error) {
          console.error('Newsletter signup error:', error);
          errorMsg.classList.remove('hidden');

          // Track error
          if (window.posthog) {
            window.posthog.capture('signup_form_error', {
              placement,
              error: error.message,
              timestamp: new Date().toISOString()
            });
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = `<span>${placement === 'article-end' ? 'Subscribe Now' : 'Get Started'}</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>`;
        }
      });
    });
  });
</script>

<style>
  .newsletter-signup {
    backdrop-filter: blur(10px);
  }
</style>
